name: Deploy Preview & Review Notification

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-and-notify:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- VERCEL URL RETRIEVAL (Minimized to capture URL) ---
      - name: Get Deploy Preview URL
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod=false' 
        id: deploy
      # --- END VERCEL URL RETRIEVAL ---
      
      # --- NEW AI & TELEGRAM STEPS ---
      # 1. Ensure GitHub CLI is Installed
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y
          
      # 2. STAGE 1: Wait for CodeRabbit Status Comment to Finish 
      - name: Wait for Review Completion
        id: wait_for_review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PULL_REQUEST_NUMBER=${{ github.event.pull_request.number }}
          # Recommended bot name is coderabbitai for robustness
          AI_BOT_USERNAME="coderabbitai"
          MAX_ATTEMPTS=60
          SLEEP_TIME=10
          
          echo "--- STAGE 1: POLLING BOT STATUS COMMENT ---"

          for ((i=1; i<=$MAX_ATTEMPTS; i++)); do
            echo "Attempt $i/$MAX_ATTEMPTS: Checking bot status comment..."
            
            set -o pipefail
            
            # Fetch the body of the LATEST comment made by the bot
            BOT_COMMENT_BODY=$(gh pr view "$PULL_REQUEST_NUMBER" --json comments 2>/dev/null \
              | jq -r '.comments[] | select(.author.login == "'"$AI_BOT_USERNAME"'") | .body' 2>/dev/null \
              | head -n 1)
              
            set +o pipefail
            
            # --- CRITICAL DEBUG: Show the RAW HTML/Markdown content ---
            echo "::debug::RAW BOT COMMENT BODY at attempt $i:"
            echo "$BOT_COMMENT_BODY"
            
            # CRITICAL: We rely on the log to confirm the exact processing phrase.
            # We use 'Currently processing new changes' for the check now.
            if echo "$BOT_COMMENT_BODY" | grep -q "Currently processing new changes"; then
              echo "Status: Still reviewing or processing. Waiting..."
            else
              echo "Status: Status message NOT found. Assuming review is complete."
              break
            fi
            
            if [[ $i -eq $MAX_ATTEMPTS ]]; then
              echo "Timeout: Bot status comment did not finalize after 10 minutes."
              exit 1
            fi
            
            sleep $SLEEP_TIME
          done

      # 3. STAGE 2: Get Final Summary from PR Description (Single Fetch)
      - name: Get Final Summary from PR Description
        id: get_summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # This step runs once, knowing the data is ready from Stage 1
        run: |
          PULL_REQUEST_NUMBER=${{ github.event.pull_request.number }}
          FULL_BODY=""
          
          echo "--- STAGE 2: FETCHING FINAL SUMMARY (Non-Polling) ---"

          # Fetch the PR body content once
          RAW_BODY_OUTPUT=$(gh pr view "$PULL_REQUEST_NUMBER" --json body 2>/dev/null)
          FULL_BODY=$(echo "$RAW_BODY_OUTPUT" | jq -r '.body')

          # 2. Extract the concise summary using SED
          if echo "$FULL_BODY" | grep -q "Summary by CodeRabbit"; then
            # 1. Use sed to delete everything *before* "Summary by CodeRabbit" and keep the rest.
            SUMMARY=$(echo "$FULL_BODY" | sed '1,/Summary by CodeRabbit/d')
            
            # 2. CRITICAL CLEANUP: Remove the promotional/tip lines and the end comment tag.
            SUMMARY=$(echo "$SUMMARY" | sed '/<sub>/d' | sed '/<!-- end of auto-generated comment:/d')

            if [[ -z "$SUMMARY" ]]; then
              SUMMARY="[Concise summary extraction failed, but full review is on the PR.]"
            fi
          else
            SUMMARY="[AI Summary marker not found in description. Review likely failed.]"
          fi

          # 3. Prepare multi-line output
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # 4. Send Consolidated Telegram Notification
      - name: Send Consolidated Telegram Message
        uses: appleboy/telegram-action@master # A reliable marketplace action
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ðŸ”” *New PR for Review: ${{ github.event.pull_request.title }}*
            
            **By:** @${{ github.event.pull_request.user.login }}
            
            ðŸš€ *Live Preview:* [Click to Test](${{ steps.deploy.outputs.preview-url }})
            
            ðŸ¤– *AI Code Review Summary:*
            ${{ steps.get_summary.outputs.summary }}
            
            [Link to GitHub PR](${{ github.event.pull_request.html_url }})
          parse_mode: markdown
          disable_web_page_preview: true # Keeps the message clean