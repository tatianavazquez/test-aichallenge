name: Deploy Preview & Review Notification

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-and-notify:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- EXISTING VERCEL STEPS ---
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: .
          vercel-args: '--prod=false'
        id: deploy
      # --- END EXISTING VERCEL STEPS ---
      
      # --- NEW AI & TELEGRAM STEPS ---
      # 1. NEW: Ensure GitHub CLI is Installed
      # This fixes "command not found" errors for 'gh'
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y
      # 1. Get AI Summary from PR Comment (ROBUST POLLING WITH DEBUG)
      - name: Get AI Summary from PR Comment
        id: get_summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- SAFELY DEFINED VARIABLES ---
          AI_BOT_USERNAME="coderabbitai[bot]" 
          PULL_REQUEST_NUMBER=${{ github.event.pull_request.number }}
          MAX_ATTEMPTS=60
          SLEEP_TIME=10
          FULL_COMMENT=""

          echo "--- DEBUG START ---"
          echo "Username being sought: $AI_BOT_USERNAME"
          echo "PR Number: $PULL_REQUEST_NUMBER"
          echo "-------------------"

          # Start the Polling Loop
          for ((i=1; i<=$MAX_ATTEMPTS; i++)); do
            echo "Attempt $i/$MAX_ATTEMPTS: Checking for final content..."
            
            set -o pipefail
            
            # --- DEBUG: FETCH ALL COMMENTS FOR THE BOT ---
            RAW_JSON_OUTPUT=$(gh pr view "$PULL_REQUEST_NUMBER" --json comments 2>/dev/null)
            
            # Use JQ to find and print ALL comments made by the specific bot
            BOT_COMMENTS=$(echo "$RAW_JSON_OUTPUT" | jq -r '.comments[] | select(.author.login == "'"$AI_BOT_USERNAME"'") | .body')
            
            echo "::debug::Total comments found from $AI_BOT_USERNAME (in all attempts):"
            echo "$BOT_COMMENTS"

            # Fetch the body of the latest comment
            FULL_COMMENT=$(echo "$RAW_JSON_OUTPUT" | jq -r '.comments[] | select(.author.login == "'"$AI_BOT_USERNAME"'") | .body' 2>/dev/null | head -n 1)
              
            set +o pipefail

            # --- DEBUG: PRINT THE LATEST COMMENT CONTENT ---
            echo "::debug::LATEST comment content being evaluated:"
            echo "$FULL_COMMENT"
            echo "-------------------"

            # Crucial check: Has CodeRabbit finished and posted the summary?
            if echo "$FULL_COMMENT" | grep -q "## üêá Summary"; then
              echo "SUCCESS: Final CodeRabbit Summary found after $i attempts."
              break # Exit the loop
            fi
            
            if [[ $i -eq $MAX_ATTEMPTS ]]; then
              echo "Timeout: Final CodeRabbit comment content not found after 10 minutes."
              break
            fi
            
            sleep $SLEEP_TIME
          done

          echo "--- DEBUG END: Starting Extraction ---"

          # 2. Extract the concise summary
          if echo "$FULL_COMMENT" | grep -q "## üêá Summary"; then
            # AWK extraction logic remains the same (isolates the short summary)
            SUMMARY=$(echo "$FULL_COMMENT" | awk '
              /## üêá Summary/{print; summary=1; next}
              /## üîç Detailed Code Review/ || /---/{summary=0; next}
              summary==1{print}
            ' | sed 's/## üêá Summary//g' | sed '/^$/d')

            if [[ -z "$SUMMARY" ]]; then
              SUMMARY="[Concise summary extraction failed, but full review is on the PR.]"
            fi
          else
            SUMMARY="[AI Review not complete within timeout. Check the PR on GitHub.]"
          fi

          # 3. Prepare multi-line output
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      # 4. Send Consolidated Telegram Notification
      - name: Send Consolidated Telegram Message
        uses: appleboy/telegram-action@master # A reliable marketplace action
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üîî *New PR for Review: ${{ github.event.pull_request.title }}*
            
            **By:** @${{ github.event.pull_request.user.login }}
            
            üöÄ *Live Preview:* [Click to Test](${{ steps.deploy.outputs.preview-url }})
            
            ü§ñ *AI Code Review Summary:*
            ${{ steps.get_summary.outputs.summary }}
            
            [Link to GitHub PR](${{ github.event.pull_request.html_url }})
          parse_mode: markdown
          disable_web_page_preview: true # Keeps the message clean