name: Deploy Preview & Review Notification

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-and-notify:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- VERCEL URL RETRIEVAL (Minimized to capture URL) ---
      - name: Get Deploy Preview URL
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          # Important: Specify that it's NOT a production deploy
          vercel-args: '--prod=false' 
        id: deploy # Keep this ID for the Telegram step to reference the URL
      # --- END VERCEL URL RETRIEVAL ---
      
      # --- NEW AI & TELEGRAM STEPS ---
      # 1. Ensure GitHub CLI is Installed
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y
          
      # 2. Poll PR Body for Final AI Summary (Consolidated and Robust Logic)
      - name: Wait and Get Final AI Summary
        id: get_summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PULL_REQUEST_NUMBER=${{ github.event.pull_request.number }}
          MAX_ATTEMPTS=60 
          SLEEP_TIME=5 # Polling every 5 seconds for 5 minutes max
          FULL_BODY=""
          OLD_SUMMARY_MARKER="SUMMARY_BY_CODE_RABBIT_MARKER"

          echo "--- DEBUG START: POLLING PR DESCRIPTION FOR FINAL EDIT ---"
          echo "PR Number: $PULL_REQUEST_NUMBER"
          echo "----------------------------------------------------------"

          # 1. Capture the current (old) PR description body hash before CodeRabbit updates it.
          # This helps distinguish between an *old* complete summary and the *new* complete summary.
          RAW_BODY_OUTPUT=$(gh pr view "$PULL_REQUEST_NUMBER" --json body 2>/dev/null)
          if echo "$RAW_BODY_OUTPUT" | grep -q "Summary by CodeRabbit"; then
            # Create a hash of the initial summary content
            OLD_SUMMARY_MARKER=$(echo "$RAW_BODY_OUTPUT" | md5sum | awk '{print $1}')
            echo "::debug::Initial PR body hash: $OLD_SUMMARY_MARKER"
          fi

          # Start the Polling Loop
          for ((i=1; i<=$MAX_ATTEMPTS; i++)); do
            echo "Attempt $i/$MAX_ATTEMPTS: Checking PR body for final completion marker..."
            
            set -o pipefail
            
            # Fetch the current PR body content
            RAW_BODY_OUTPUT=$(gh pr view "$PULL_REQUEST_NUMBER" --json body 2>/dev/null)
            FULL_BODY=$(echo "$RAW_BODY_OUTPUT" | jq -r '.body')
              
            set +o pipefail
            
            # Hash the current body content to detect a change
            CURRENT_SUMMARY_MARKER=$(echo "$FULL_BODY" | md5sum | awk '{print $1}')

            # --- DEBUG: Show the current state during polling ---
            echo "::debug::CURRENT PR BODY HASH at ATTEMPT $i: $CURRENT_SUMMARY_MARKER"
            echo "------------------------------------------------"
            
            # CRITICAL FIX: Break only when 1) the final tag is present AND 2) the content has changed (new review).
            if echo "$FULL_BODY" | grep -q ""; then
                if [[ "$CURRENT_SUMMARY_MARKER" != "$OLD_SUMMARY_MARKER" ]]; then
                    echo "SUCCESS: Final completion marker found AND content has changed. Review is complete after $i attempts."
                    echo "::debug::FINAL EDITED PR BODY CONTENT:"
                    echo "$FULL_BODY"
                    break # Exit the loop
                else
                    echo "Status: Marker found, but content is unchanged since workflow start. Waiting for bot edit..."
                fi
            fi
            
            if [[ $i -eq $MAX_ATTEMPTS ]]; then
              echo "Timeout: Final Summary completion marker not found after 5 minutes."
              break
            fi
            
            sleep $SLEEP_TIME
          done

          echo "--- DEBUG END: Starting Extraction ---"

          # 2. Extract the concise summary using SED
          if echo "$FULL_BODY" | grep -q "Summary by CodeRabbit"; then
            # 1. Use sed to delete everything *before* "Summary by CodeRabbit" and keep the rest.
            SUMMARY=$(echo "$FULL_BODY" | sed '1,/Summary by CodeRabbit/d')
            
            # 2. CLEANUP: Remove the promotional/tip lines and the end comment tag.
            SUMMARY=$(echo "$SUMMARY" | sed '/<sub>/d' | sed '/
      
      # 4. Send Consolidated Telegram Notification
      - name: Send Consolidated Telegram Message
        uses: appleboy/telegram-action@master # A reliable marketplace action
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ðŸ”” *New PR for Review: ${{ github.event.pull_request.title }}*
            
            **By:** @${{ github.event.pull_request.user.login }}
            
            ðŸš€ *Live Preview:* [Click to Test](${{ steps.deploy.outputs.preview-url }})
            
            ðŸ¤– *AI Code Review Summary:*
            ${{ steps.get_summary.outputs.summary }}
            
            [Link to GitHub PR](${{ github.event.pull_request.html_url }})
          parse_mode: markdown
          disable_web_page_preview: true # Keeps the message clean