name: Deploy Preview & Review Notification

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-and-notify:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- VERCEL URL RETRIEVAL (No redundant build/install) ---
      # Vercel's integration handles the build/deploy. This step
      # just calls the Vercel action to retrieve the URL output.
      - name: Get Deploy Preview URL
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          # Important: Specify that it's NOT a production deploy
          vercel-args: '--prod=false' 
        id: deploy # Keep this ID for the Telegram step to reference the URL
      # --- END VERCEL URL RETRIEVAL ---
      
      # --- NEW AI & TELEGRAM STEPS ---
      # 1. NEW: Ensure GitHub CLI is Installed
      # This fixes "command not found" errors for 'gh'
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y
      # 2. Poll PR Comments for AI Summary
      - name: Get AI Summary from PR Comment
        id: get_summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- SAFELY DEFINED VARIABLES ---
          PULL_REQUEST_NUMBER=${{ github.event.pull_request.number }}
          MAX_ATTEMPTS=60
          SLEEP_TIME=10
          FULL_BODY=""

          echo "--- DEBUG START: TARGETING PR BODY (Description) ---"
          echo "PR Number: $PULL_REQUEST_NUMBER"
          echo "-----------------------------------------------------"

          # --- DEBUG BEFORE LOOP: CHECK INITIAL STATE (Unedited) ---
          RAW_BODY_OUTPUT=$(gh pr view "$PULL_REQUEST_NUMBER" --json body 2>/dev/null)
          INITIAL_BODY=$(echo "$RAW_BODY_OUTPUT" | jq -r '.body')

          echo "::debug::INITIAL PR DESCRIPTION STATE (Before Polling Starts):"
          echo "$INITIAL_BODY"
          echo "------------------------------------------------------"

          # Start the Polling Loop
          for ((i=1; i<=$MAX_ATTEMPTS; i++)); do
            echo "Attempt $i/$MAX_ATTEMPTS: Checking PR body for bot edit..."
            
            set -o pipefail
            
            RAW_BODY_OUTPUT=$(gh pr view "$PULL_REQUEST_NUMBER" --json body 2>/dev/null)
            FULL_BODY=$(echo "$RAW_BODY_OUTPUT" | jq -r '.body')
              
            set +o pipefail

            # --- DEBUG: Show the current state during polling ---
            echo "::debug::CURRENT PR BODY CONTENT AT ATTEMPT $i (Tracking edit):"
            if [[ "$FULL_BODY" == "null" || -z "$FULL_BODY" ]]; then
              echo "[Content empty/null: PR body is empty or fetch failed.]"
            else
              echo "$FULL_BODY"
            fi
            echo "------------------------------------------------"

            # Crucial check: Has the bot finished updating the body with the Summary?
            if echo "$FULL_BODY" | grep -q "Summary by CodeRabbit"; then
              echo "SUCCESS: Bot edit found in PR body, proceeding to extraction after $i attempts."
              echo "::debug::FINAL EDITED PR BODY CONTENT:"
              echo "$FULL_BODY"
              break # Exit the loop
            fi
            
            if [[ $i -eq $MAX_ATTEMPTS ]]; then
              echo "Timeout: Final Summary not found in PR body after 10 minutes."
              break
            fi
            
            sleep $SLEEP_TIME
          done

          echo "--- DEBUG END: Starting Extraction ---"

          # 2. Extract the concise summary using SED
          if echo "$FULL_BODY" | grep -q "Summary by CodeRabbit"; then
            # 1. Use sed to delete everything *before* "Summary by CodeRabbit" and keep the rest.
            SUMMARY=$(echo "$FULL_BODY" | sed '1,/Summary by CodeRabbit/d')
            
            # 2. CRITICAL CLEANUP: Remove the promotional/tip lines.
            SUMMARY=$(echo "$SUMMARY" | sed '/<sub>/d' | sed '/
      
      # 4. Send Consolidated Telegram Notification
      - name: Send Consolidated Telegram Message
        uses: appleboy/telegram-action@master # A reliable marketplace action
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ðŸ”” *New PR for Review: ${{ github.event.pull_request.title }}*
            
            **By:** @${{ github.event.pull_request.user.login }}
            
            ðŸš€ *Live Preview:* [Click to Test](${{ steps.deploy.outputs.preview-url }})
            
            ðŸ¤– *AI Code Review Summary:*
            ${{ steps.get_summary.outputs.summary }}
            
            [Link to GitHub PR](${{ github.event.pull_request.html_url }})
          parse_mode: markdown
          disable_web_page_preview: true # Keeps the message clean