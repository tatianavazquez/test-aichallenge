name: Deploy Preview & Review Notification

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-and-notify:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- EXISTING VERCEL STEPS ---
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: .
          vercel-args: '--prod=false'
        id: deploy
      # --- END EXISTING VERCEL STEPS ---
      
      # --- NEW AI & TELEGRAM STEPS ---
      # 1. NEW: Ensure GitHub CLI is Installed
      # This fixes "command not found" errors for 'gh'
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y
      # 2. Poll PR Comments for AI Summary
      - name: Get AI Summary from PR Comment
        id: get_summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- SAFELY DEFINED VARIABLES ---
          AI_BOT_USERNAME="${{ github.event.pull_request.user.login }}" 
          PULL_REQUEST_NUMBER=${{ github.event.pull_request.number }}
          MAX_ATTEMPTS=60
          SLEEP_TIME=10
          FULL_COMMENT=""

          echo "--- DEBUG START: TARGETING FIRST COMMENT BY AUTHOR ---"
          echo "Targeting PR Author: $AI_BOT_USERNAME"
          echo "-----------------------------------------------------"
          
          # We skip the "INITIAL_COMMENT_BODY" check because it relies on the same logic that is failing.
          # We proceed directly to the loop with the fix.
          
          # Start the Polling Loop
          for ((i=1; i<=$MAX_ATTEMPTS; i++)); do
            echo "Attempt $i/$MAX_ATTEMPTS: Checking for bot edit..."
            
            set -o pipefail
            
            # Fetch the raw JSON output containing all comments
            RAW_JSON_OUTPUT=$(gh pr view "$PULL_REQUEST_NUMBER" --json comments 2>/dev/null)
            
            # CRITICAL FIX: Use a robust JQ query to filter for the first comment by the author.
            # This query ensures the filtering happens correctly:
            FULL_COMMENT=$(echo "$RAW_JSON_OUTPUT" \
              | jq -r '[.comments[] 
                  | select(.author.login == "'"$AI_BOT_USERNAME"'")] 
                  | sort_by(.createdAt) 
                  | .[0].body' 2>/dev/null)
              
            set +o pipefail

            # --- DEBUG: Show the current state during polling ---
            echo "::debug::CURRENT COMMENT STATE AT ATTEMPT $i (Expecting edit):"
            # Print a placeholder if the content is empty, to confirm the script ran.
            if [[ -z "$FULL_COMMENT" ]]; then
              echo "[Content empty: Author may not have posted the initial comment yet, or JQ failed.]"
            else
              echo "$FULL_COMMENT"
            fi
            echo "------------------------------------------------"

            # Crucial check: Has the bot finished updating the comment with the Summary?
            if echo "$FULL_COMMENT" | grep -q "Summary by CodeRabbit"; then
              echo "SUCCESS: Bot edit found, proceeding to extraction after $i attempts."
              # FINAL DEBUG: Explicitly show the final, edited content before extraction
              echo "::debug::FINAL EDITED COMMENT CONTENT:"
              echo "$FULL_COMMENT"
              break # Exit the loop
            fi
            
            if [[ $i -eq $MAX_ATTEMPTS ]]; then
              echo "Timeout: Bot edit not found after 10 minutes."
              break
            fi
            
            sleep $SLEEP_TIME
          done

          echo "--- DEBUG END: Starting Extraction ---"

          # 2. Extract the concise summary using SED
          # ... (Extraction logic remains the same)
          if echo "$FULL_COMMENT" | grep -q "Summary by CodeRabbit"; then
            SUMMARY=$(echo "$FULL_COMMENT" | sed '1,/Summary by CodeRabbit/d')
            
            if [[ -z "$SUMMARY" ]]; then
              SUMMARY="[Concise summary extraction failed, but full review is on the PR.]"
            fi
          else
            SUMMARY="[AI Review not complete within timeout. Check the PR on GitHub.]"
          fi

          # 3. Prepare multi-line output
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # 4. Send Consolidated Telegram Notification
      - name: Send Consolidated Telegram Message
        uses: appleboy/telegram-action@master # A reliable marketplace action
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ðŸ”” *New PR for Review: ${{ github.event.pull_request.title }}*
            
            **By:** @${{ github.event.pull_request.user.login }}
            
            ðŸš€ *Live Preview:* [Click to Test](${{ steps.deploy.outputs.preview-url }})
            
            ðŸ¤– *AI Code Review Summary:*
            ${{ steps.get_summary.outputs.summary }}
            
            [Link to GitHub PR](${{ github.event.pull_request.html_url }})
          parse_mode: markdown
          disable_web_page_preview: true # Keeps the message clean