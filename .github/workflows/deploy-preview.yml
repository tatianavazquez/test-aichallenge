name: Deploy Preview & Review Notification

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-and-notify:
    runs-on: ubuntu-latest
    
    # Give this job permissions to read comments, which is needed for the 'Get AI Summary' step
    permissions:
      pull-requests: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- EXISTING VERCEL STEPS ---
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: .
          vercel-args: '--prod=false'
        id: deploy
      # --- END EXISTING VERCEL STEPS ---
      
      # --- NEW AI & TELEGRAM STEPS ---
      
      # 1. Wait for AI Review Completion (Crucial for timing!)
      # The AI App runs asynchronously. We pause to let it post its review comment.
      - name: Wait for AI Review to Post
        run: |
          echo "Waiting 45 seconds for AI Review to complete and post its comment..."
          sleep 45s # Adjust this time if needed, but 45s is a safe starting point

      # 2. Install GitHub CLI and Extract AI Summary from PR Comments
      # We use the GitHub CLI tool to read the comment the AI bot just posted.
     # 2. Get AI Summary from PR Comment (Extracts CONCISE Telegram Summary)
      - name: Get AI Summary from PR Comment
        id: get_summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # **IMPORTANT: Make sure AI_BOT_USERNAME matches the bot's username**
          AI_BOT_USERNAME="coderabbitai[bot]" 
          
          # 1. Fetch the full body of the latest comment from the AI bot
          FULL_COMMENT=$(gh pr view ${{ github.event.pull_request.number }} --json comments \
            | jq -r '.comments[] | select(.author.login == "'"$AI_BOT_USERNAME"'") | .body' \
            | head -n 1)

          # 2. Use AWK to extract content between the 'Summary' and 'Detailed Code Review' sections
          # This assumes CodeRabbit uses headers like "## Summary" and "## Detailed Code Review".
          # We also strip the auto-generated comment line.
          SUMMARY=$(echo "$FULL_COMMENT" | awk '
            # Flag to know if we are inside the summary block
            /## üêá Summary/{print; summary=1; next}
            # Stop when we hit the detailed section or a horizontal rule
            /## üîç Detailed Code Review/ || /---/{summary=0; next}
            # Print lines only if we are in the summary block
            summary==1{print}
          ' | sed 's/## üêá Summary//g' | sed '/^$/d') # Clean up the header and empty lines

          # 3. Prepare multi-line output for the Telegram action
          if [[ -z "$SUMMARY" ]]; then
            SUMMARY="[Could not extract concise AI Summary. See the PR for the full review.]"
          fi

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 3. Send Consolidated Telegram Notification
      - name: Send Consolidated Telegram Message
        uses: appleboy/telegram-action@master # A reliable marketplace action
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üîî *New PR for Review: ${{ github.event.pull_request.title }}*
            
            **By:** @${{ github.event.pull_request.user.login }}
            
            üöÄ *Live Preview:* [Click to Test](${{ steps.deploy.outputs.preview-url }})
            
            ü§ñ *AI Code Review Summary:*
            ${{ steps.get_summary.outputs.summary }}
            
            [Link to GitHub PR](${{ github.event.pull_request.html_url }})
          parse_mode: markdown
          disable_web_page_preview: true # Keeps the message clean